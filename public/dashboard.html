<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard de Saída</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="logo">
    <img src="logo.png" alt="Logo" />
  </div>

  <h1 class="dashboard-title">Dashboard de Saída</h1>
  <div class="dashboard-container">
    <div class="columns-container">
      <!-- Materiais -->
      <div class="list-column">
        <h3>Materiais</h3>
        <ul id="lista-materiais"></ul>
      </div>
      <!-- Equipamentos -->
      <div class="list-column">
        <h3>Equipamentos</h3>
        <ul id="lista-equipamentos"></ul>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // renderiza lists
    function renderDashboard(data) {
      const mat = document.getElementById('lista-materiais');
      const eqp = document.getElementById('lista-equipamentos');
      mat.innerHTML = '';
      eqp.innerHTML = '';

      data.forEach((item, i) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <strong>${item.nome}</strong> —
          ${item.descricao} (${item.quantidade} ${item.unidade})
        `;
        // botão remover / devolvido
        const btn = document.createElement('button');
        btn.className = 'botao-remover';
        btn.textContent = item.tipo === 'equipamento'
          ? 'Devolvido' : 'Remover';
        btn.onclick = () => {
          fetch(`/remover/${i}`, { method: 'POST' })
            .catch(console.error);
        };
        li.appendChild(btn);

        if (item.tipo === 'equipamento') {
          // checkbox entregue
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = item.delivered;
          chk.onchange = () => {
            fetch(`/reordenar/${i}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ delivered: chk.checked })
            })
            .then(() => fetchAndRender())
            .catch(console.error);
          };
          li.insertBefore(chk, li.firstChild);
          eqp.appendChild(li);
        } else {
          mat.appendChild(li);
        }
      });
    }

    function fetchAndRender() {
      fetch('/api/saidas')
        .then(r => r.json())
        .then(renderDashboard)
        .catch(console.error);
    }

    // WebSocket → atualiza ao receber 'update'
    const socket = io();
    socket.on('update', fetchAndRender);

    // primeira chamada
    fetchAndRender();
  </script>
</body>
</html>
